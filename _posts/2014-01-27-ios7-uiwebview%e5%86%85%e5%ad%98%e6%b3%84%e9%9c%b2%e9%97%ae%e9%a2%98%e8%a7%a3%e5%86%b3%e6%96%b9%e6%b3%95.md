---
title: iOS7 UIWebView内存泄露问题解决方法
author: admin
layout: post
permalink: /ios7-uiwebview%e5%86%85%e5%ad%98%e6%b3%84%e9%9c%b2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95/
categories:
  - iOS
tags:
  - iOS 7
  - UIWebView
  - 内存泄露
---
关于iOS的UIWebView内存泄露的问题，已经存在了很长时间。一直也没有什么好的解决方法。最近因公司的一个项目，因为内存问题一直闪退。为了解决这个问题，在网上找了很多方法，但是基本上都不怎么好用问题依旧。以前也碰到过这个问题，当时的解决方法就是设置NSURLCache大小。因为iOS当中的网络通讯默认都是通过NSURLConnection来实现的。所以UIWebView内部通讯也是通过NSURLConnection来下载网页资源的。

<pre class="lang:default decode:true">- (BOOL)application:(UIApplication*)application didFinishLaunchingWithOptions:(NSDictionary*)launchOptions
{

    int cacheSizeMemory = 1*1024*1024; // 4MB
    int cacheSizeDisk = 5*1024*1024; // 32MB
    NSURLCache *sharedCache = [[[NSURLCache alloc] initWithMemoryCapacity:cacheSizeMemory diskCapacity:cacheSizeDisk diskPath:@"nsurlcache"] autorelease];
    [NSURLCache setSharedURLCache:sharedCache];
}</pre>

并且在收到内存警告的时候，清除缓存内容。

<pre class="lang:default decode:true">- (void)applicationDidReceiveMemoryWarning:(UIApplication*)application
{
    [[NSURLCache sharedURLCache] removeAllCachedResponses];
}</pre>

以及在释放UIWebView的时候

<pre class="lang:default decode:true">_webView.delegate = nil;
[_webView loadHTMLString:@"" baseURL:nil];
[_webView stopLoading];
[_webView removeFromSuperview];
[[NSURLCache sharedURLCache] removeAllCachedResponses];
[_webView release];</pre>

但是这么做基本上效果不是很大。囧啊。。

今天偶然的机会看到一篇国外的Blog文章，终于有种找到我想要的答案了。

原文地址是：http://blog.techno-barje.fr//post/2010/10/04/UIWebView-secrets-part1-memory-leaks-on-xmlhttprequest/

有兴趣的朋友可以去看看，大概说的内容就是Html当中的js代码会引起内存泄露的问题。

<pre class="lang:default decode:true">var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
      // Do whatever you want with the result

    }
  };
  xmlhttp.open("GET", "http://your.domain/your.request/...", true);
  xmlhttp.send();</pre>

解决这个问题的方法是在webViewDidFinishLoad方法中设置如下：

<pre class="lang:default decode:true crayon-selected">[[NSUserDefaults standardUserDefaults] setInteger:0 forKey:@"WebKitCacheModelPreferenceKey"];
    [[NSUserDefaults standardUserDefaults] setBool:NO forKey:@"WebKitDiskImageCacheEnabled"];//自己添加的，原文没有提到。
    [[NSUserDefaults standardUserDefaults] setBool:NO forKey:@"WebKitOfflineWebApplicationCacheEnabled"];//自己添加的，原文没有提到。
    [[NSUserDefaults standardUserDefaults] synchronize];</pre>

关于NSUserDefaults的另类用法还有比如设置UserAgent也可以通过NSUserDefaults来设置。